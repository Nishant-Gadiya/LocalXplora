
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>LocalXplora — Interactive Bengaluru Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        /* ---------- VARIABLES & RESET ---------- */
        :root {
            --blue-600: #007BFF;
            --blue-700: #0056b3;
            --bg: #f5f7fb;
            --card-radius: 12px;
            --card-shadow: 0 8px 24px rgba(5, 10, 25, 0.12);
            --text-dark: #071223;
            --muted: #6b7280;
            --glass: rgba(255, 255, 255, 0.9);
        }
        * {
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Poppins', system-ui, Arial, sans-serif;
            color: var(--text-dark);
            background: linear-gradient(-45deg, #1E3C72, #2A5298, #4e73df, #8e9eab);
            background-size: 400% 400%;
            animation: gradientShift 18s ease infinite;
        }
        a {
            color: inherit;
            text-decoration: none;
        }
        button {
            font-family: inherit;
            cursor: pointer;
            border: 0
        }
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%
            }
            50% {
                background-position: 100% 50%
            }
            100% {
                background-position: 0% 50%
            }
        }
        /* ---------- LAYOUT ---------- */
       /* ---------- NAVBAR: slightly darker, semi-opaque with blur ---------- */
header#navbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 18px;
    color: #e6e9ef;
    /* darker background while still being semi-transparent so the page gradient shows through */
    background: rgba(6, 12, 30, 0.48);
    backdrop-filter: blur(6px); /* soft glass effect */
    -webkit-backdrop-filter: blur(6px);
    border-radius: 10px; /* small rounding so the navbar looks neat on top */
    margin: 10px 18px; /* space from edges */
    position: sticky;
    top: 8px; /* small offset so rounded corners are visible */
    z-index: 1200;
    box-shadow: 0 8px 24px rgba(5, 10, 25, 0.12);
}



        #brand {
            display: flex;
            align-items: center;
            gap: 12px
        }
        .logo {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: linear-gradient(135deg, #1E3C72, #2A5298);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            box-shadow: var(--card-shadow)
        }
        nav#main-nav {
            display: flex;
            color: white;
            gap: 14px;
            align-items: center
        }
        nav#main-nav a {
            padding: 8px 12px;
            border-radius: 8px;
            color: white;
            
            font-weight: 600;
            opacity: .95
        }
        nav#main-nav a:hover {
            background: rgba(255, 255, 255, 0.08)
        }
        /* three-dot button */
        #nav-toggle {
            display: none;
            background: none;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 18px
        }
        /* MOBILE NAV: slide down */
        @media (max-width:720px) {
            nav#main-nav {
                position: fixed;
                right: 12px;
                top: 60px;
                background: rgba(255, 255, 255, 0.98);
                flex-direction: column;
                padding: 12px;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
                overflow: hidden;
                max-height: 0;
                opacity: 0;
                transition: max-height .35s ease, opacity .35s ease;
                z-index: 1300
            }
            nav#main-nav.open {
                max-height: 360px;
                opacity: 1
            }
            #nav-toggle {
                display: block
            }
        }
        /* HERO */
        /* ---------- HERO: outline margin effect ---------- */
#hero {
    min-height: 56vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 36px 18px;
    color: white;
    position: relative;

    /* outline + offset gives the visual 'margin/outline' you asked for */
    outline: 2px solid rgba(255, 255, 255, 0.12);
    outline-offset: 14px;

    /* rounded corners + subtle shadow to lift from background */
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(2, 8, 20, 0.18);

    /* ensure hero content doesn't hit the viewport edges */
    margin: 22px 18px;
    /* keep visual contrast but keep gradient from body showing through */
    background: linear-gradient(180deg, rgba(6, 12, 30, 0.48), rgba(6, 12, 30, 0.48));
}

/* Small tweak so hero-inner's rounded corners look smooth on narrow screens */
@media (max-width:820px) {
  #hero { padding: 28px 12px; margin: 16px 12px; }
}
        .hero-inner {
            max-width: 1100px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 22px;
            align-items: center
        }
        .hero-text h1 {
            font-size: clamp(1.5rem, 3.2vw, 2.4rem);
            margin: 0 0 10px;
            line-height: 1.05
        }
        .hero-text p {
            margin: 0 0 14px;
            opacity: .95;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 500
        }
        .hero-ctas {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }
        .btn {
            padding: 10px 16px;
            border-radius: 10px;
            background: var(--blue-600);
            color: white;
            font-weight: 600;
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12)
        }
        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.12)
        }
        .cta-card {
            background: var(--glass);
            border-radius: 16px;
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: var(--card-shadow);
            color: var(--text-dark)
        }
        main {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 18px 40px
        }
        .section-title {
            font-size: 1.2rem;
            margin: 12px 6px 8px;
            font-weight: 700;
            color: var(--text-dark)
        }
        /* sliders */
        .slider {
            display: flex;
            gap: 14px;
            overflow-x: auto;
            padding: 12px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch
        }
        .card {
            flex: 0 0 260px;
            height: 220px;
            border-radius: var(--card-radius);
            overflow: hidden;
            position: relative;
            box-shadow: var(--card-shadow);
            scroll-snap-align: start;
            background: white;
            display: flex;
            align-items: flex-end
        }
        .card img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover
        }
        .card video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover
        }
        .card .label {
            position: relative;
            z-index: 2;
            padding: 10px 12px;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.45), transparent);
            color: white;
            font-weight: 700;
            width: 100%
        }
        .card:hover {
            transform: translateY(-6px) scale(1.03);
            transition: transform .22s ease
        }
        /* MAP overlay */
        #map-section {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1400;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.97), rgba(255, 255, 255, 0.99));
            flex-direction: column;
        }
        #map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 18px;
            gap: 8px
        }
        #map-close {
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 16px
        }
        #map {
            height: 48vh;
            width: 100%
        }
        #info-section {
            padding: 18px;
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 16px;
            align-items: start;
            overflow: auto;
            max-height: calc(100vh - 48vh - 60px);
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.06)
        }
        #related-media {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px
        }
        #related-media img, #related-media video {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08)
        }
        /* Floating action buttons (bottom-right) */
        #floating-btns {
            position: fixed;
            bottom: 18px;
            right: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1500
        }
        .fab {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 14px;
            border-radius: 999px;
            background: var(--blue-600);
            color: white;
            font-weight: 600;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18)
        }
        .fab.secondary {
            background: white;
            color: var(--text-dark);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08)
        }
        .fab .icon {
            font-size: 18px
        }
        /* guide button in card */
        #guide-card {
            background: white;
            margin-top: 18px;
            padding: 18px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px
        }
        #footer {
            margin-top: 26px;
            background: #071226;
            color: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center
        }
        /* small responsive tweaks */
        @media (max-width:1100px) {
            .hero-inner {
                grid-template-columns: 1fr 300px
            }
            .card {
                flex: 0 0 220px;
                height: 200px
            }
            #info-section {
                grid-template-columns: 1fr 280px
            }
        }
        @media (max-width:820px) {
            #hero {
                min-height: 46vh;
                padding: 28px 16px
            }
            .hero-inner {
                grid-template-columns: 1fr
            }
            .cta-card {
                order: 99
            }
            .card {
                flex: 0 0 200px;
                height: 180px
            }
            #info-section {
                grid-template-columns: 1fr;
                max-height: none
            }
            #related-media {
                grid-template-columns: repeat(3, 1fr)
            }
        }
        @media (max-width:480px) {
            .card {
                flex: 0 0 150px;
                height: 140px
            }
            #related-media img, #related-media video {
                height: 88px
            }
            #map {
                height: 44vh
            }
        }
        /* subtle animations */
        .card {
            transition: transform .28s ease, box-shadow .28s ease;
            will-change: transform
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.35);
            transform: scale(0);
            animation: rippleAnim 0.6s linear;
            pointer-events: none
        }
        @keyframes rippleAnim {
            to {
                transform: scale(4);
                opacity: 0
            }
        }
        /* accessibility focus outlines */
        button:focus, a:focus {
            outline: 3px solid rgba(0, 123, 255, 0.18);
            outline-offset: 3px
        }
        /* small toast */
        #toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 86px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            opacity: 0;
            pointer-events: none;
            transition: opacity .25s ease;
            z-index: 1600
        }
        #toast.show {
            opacity: 1;
            pointer-events: auto
        }

        /* ---------- Fixes for slider video/touch behavior ---------- */
        /* make videos behave better inside touch-scroll sliders */
        .slider .card video {
            -webkit-user-drag: none;
            user-select: none;
            touch-action: manipulation; /* helps avoid blocking horizontal scroll on some devices */
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header id="navbar">
        <div id="brand">
            <div class="logo">B</div>
            <div>
                <div style="font-weight:700">LocalXplora</div>
                <div style="font-size:12px;color:var(--muted);margin-top:3px">Heritage · Hotspots · Guides</div>
            </div>
        </div>
        <nav id="main-nav" aria-label="Main navigation">
            <a href="#hero">Home</a>
            <a href="#heritage">Heritage</a>
            <a href="#popular">Popular</a>
            <a href="#guide-card">Guides</a>
            <a href="#hidden-gems">Hidden Gems</a>
        </nav>
        <button id="nav-toggle" aria-controls="main-nav" aria-expanded="false" aria-label="Menu">⋮</button>
        <div id="login-container">
            <button id="login-btn" class="btn ghost">Login</button>
        </div>
    </header>
    <section id="hero" role="region" aria-labelledby="hero-heading">
        <div class="hero-inner">
            <div class="hero-text">
                <h1 id="hero-heading">Discover Bengaluru — culture, nature, and hidden gems</h1>
                <p>From Tipu's Palaces to neighborhood cafés — explore curated heritage and popular spots, open the map to locate any place instantly.</p>
                <div class="hero-ctas">
                    <button class="btn" id="open-map-cta">Open Map</button>
                    <button class="btn ghost" id="learn-more">How it works</button>
                </div>
            </div>
            <div class="cta-card" aria-hidden="false">
                <div style="font-weight:700">Quick actions</div>
                <div style="font-size:14px;color:var(--muted)">
                    • Tap a card to open its location on the map<br>
                    • Use the search inside the map to find other places<br>
                    • Get a local guide via the 'Get Guide' button
                </div>
            </div>
        </div>
    </section>
    <main>
        <h2 class="section-title" id="heritage">Heritage & Culture</h2>
        <div class="slider" id="heritage-slider" aria-label="Heritage slider">
            <!-- NOTE: added playsinline and draggable="false" to videos -->
            <div class="card heritage-card" data-location="heritage1">
                <video src="https://assets.mixkit.co/videos/preview/mixkit-flying-over-an-ancient-temple-42092-large.mp4" muted loop playsinline draggable="false"></video>
                <div class="label">Temple Site</div>
            </div>
            <div class="card heritage-card" data-location="heritage2">
                <img src="https://source.unsplash.com/400x300/?palace,india" alt="Palace">
                <div class="label">Historic Palace</div>
            </div>
            <div class="card heritage-card" data-location="heritage3">
                <video src="https://assets.mixkit.co/videos/preview/mixkit-drone-view-of-an-ancient-temple-34208-large.mp4" muted loop playsinline draggable="false"></video>
                <div class="label">Ancient Ruins</div>
            </div>
            <div class="card heritage-card" data-location="heritage4">
                <img src="https://source.unsplash.com/400x300/?heritage,india" alt="Heritage Building">
                <div class="label">Heritage Building</div>
            </div>
            <div class="card heritage-card" data-location="heritage5">
                <video src="https://assets.mixkit.co/videos/preview/mixkit-aerial-view-of-the-city-in-india-2365-large.mp4" muted loop playsinline draggable="false"></video>
                <div class="label">City Heritage</div>
            </div>
        </div>
        <h2 class="section-title" id="popular">Popular in Bengaluru</h2>
        <div class="slider" id="popular-slider" aria-label="Popular places slider">
            <div class="card location-card" data-location="kadlekai parshe"><img src="kadlekai parshe.jpg" alt="Kadlekai Parshe"><div class="label">Kadlekai Parshe</div></div>
            <div class="card location-card" data-location="churchstreet"><img src="churchstreet.jpg" alt="Church Street"><div class="label">Church Street</div></div>
            <div class="card location-card" data-location="kormangala"><img src="kormangala.jpg" alt="Koramangala"><div class="label">Koramangala</div></div>
            <div class="card location-card" data-location="lalbagh"><img src="lalbagh.jpg" alt="Lalbagh"><div class="label">Lalbagh</div></div>
            <div class="card location-card" data-location="nandi hills"><img src="nandi hills.jpg" alt="nandi hills"><div class="label">Nandi hills</div></div>
        </div>
        </div>
        <div style="text-align:center;margin:36px 0;background-color: #f5f7fb;border-radius: 10px;padding: 2px;">
            <p>Become a local guide register here</p>
            <button class="btn" onclick="window.location.href='hiddengem.html'">🌟 Register</button>
        </div>
        <div id="guide-card">
            <div>
                <div style="font-weight:700">Getting guides made easy</div>
                <div style="color:var(--muted);margin-top:6px">There are many local part-timers ready to guide you through heritage spots and local hidden gems.</div>
            </div>
            <button style="background-color:#007BFF;color: #f5f7fb;" id="guidebtn" class="fab secondary">Get Guide</button>
        </div>
        <section id="hidden-gems" style="margin-top:20px">
            <h2 class="section-title">Hidden Gems (Add yours)</h2>
            <div style="display:flex;gap:16px;flex-wrap:wrap">
                <form id="gemForm" style="background:white;padding:12px;border-radius:10px;box-shadow:var(--card-shadow);min-width:280px;max-width:420px">
                    <div style="font-weight:600;margin-bottom:8px">Share a gem</div>
                    <label style="display:block;font-size:13px;margin-bottom:6px">Title
                        <input id="gem-title" required style="width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px">
                    </label>
                    <label style="display:block;font-size:13px;margin-bottom:6px">Location (text)
                        <input id="gem-location" required style="width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px">
                    </label>
                    <label style="display:block;font-size:13px;margin-bottom:6px">Image URL
                        <input id="gem-image" placeholder="optional" style="width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px">
                    </label>
                    <label style="display:block;font-size:13px;margin-bottom:6px">Description
                        <textarea id="gem-desc" rows="3" style="width:100%;padding:8px;border:1px solid #e6e9ef;border-radius:8px"></textarea>
                    </label>
                    <div style="display:flex;gap:10px;align-items:center">
                        <button class="btn" type="submit">Add Gem</button>
                        <div id="gem-msg" style="color:var(--muted);font-size:13px"></div>
                    </div>
                </form>
                <div style="flex:1;min-width:180px">
                    <div style="font-weight:600;margin-bottom:8px">Community Gems</div>
                    <div id="hidden-gems-slider" class="slider" aria-live="polite"></div>
                </div>
            </div>
        </section>
        <div id="footer">Made for SIH Hackathon 2025 • Prototype by LocalXplora team</div>
    </main>
    <div id="map-section" aria-hidden="true">
        <div id="map-header">
            <div style="display:flex;align-items:center;gap:12px">
                <button id="map-close" aria-label="Close map">✖</button>
                <div style="font-weight:700">Map — Bengaluru</div>
            </div>
            <div id="map-search-container" style="display:flex;gap:8px;align-items:center;max-width:480px;">
                <input id="map-search" type="text" placeholder="Search a place in Bengaluru..." aria-label="Map search" style="padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);width:100%">
                <button id="map-search-btn" class="btn" style="padding:8px 12px">Search</button>
            </div>
        </div>
        <div id="map"></div>
        <div id="info-section">
            <div id="info-text">
                <div id="info-title" style="font-weight:700">Select a place</div>
                <div id="info-desc" style="color:var(--muted);margin-top:8px">Click any card to open its location on the map.</div>
            </div>
            <div id="related-media">
                <div style="color:var(--muted);font-size:13px;padding:6px">Related images/videos will show here.</div>
            </div>
        </div>
    </div>
    <div id="floating-btns">
        <button id="map-toggle-btn" class="fab" title="Open Map"><span class="icon">🗺️</span><span>Map</span></button>
        <button id="chatbtn" class="fab" title="Open Chatbot"><span class="icon">💬</span><span>Chat</span></button>
    </div>
    <div id="toast" role="status" aria-live="polite"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        // ---------- DATA ----------
        const locations = {
            "kadlekai parshe": {
                lat: 12.95050,
                lon: 77.56790,
                images: ["kadalekaiparisheof1.jpg","kadalekaiparisheof2.jpg"],
                desc: "Kadalekai Parishe, is an annual groundnut fair held in Basavanagudi Bangalore. This two-day fair. Farmers from other parts of the state bring their first crop of groundnuts to offer to Basavanna. Also, there will be numerous stalls of Groundnuts, with all different varieties such as, freshly plucked groundnuts, fried groundnuts, with shell, unshelled, boiled groundnuts and many."
            },
            "churchstreet": {
                lat: 12.97,
                lon: 77.58,
                images: ["ChurchStreetof1.jpg","ChurchStreetof1.jpg"],
                desc: "It is a 750-metre stretch from Brigade Road to St. Mark's Road, running parallel to M G Road. The street is named for St. Mark's Cathedral to which it leads. A tourist hotspot, Church Street is a major shopping and nightlife area. It is also a popular New Year's Eve celebration centre."
            },
            "kormangala": {
                lat: 12.934533,
                lon: 77.626579,
                images: ["koramangalaof1.jpg","koramangalaof2.jpg"],
                desc: "Consequently, it has gradually developed into a commercial centre and a prominent startup hub known for its high land prices and high-end shopping options. "
            },
            "lalbagh": {
                lat: 12.9494,
                lon: 77.5847,
                images: ["lalbaghof1.jpg","lalbaghof1.jpg"],
                desc: "A haven for all nature lovers, Lal Bagh covers an area 240 acres in the heart of the city and has nearly 1,854 species of plants."
            },
            "nandi hills": {
                lat: 13.3625,
                lon: 77.70093,
                images: ["nandi hillsof1.jpg"],
                desc: "Nandi Hills is an ancient hill fortress built by the Ganga dynasty in the Chikkaballapur district of Karnataka state. It is now a locality situated 10 km from Chickballapur town and approximately 60 km from Bengaluru."
            },
            // Heritage locations with videos/images
            "heritage1": {
                lat: 12.97,
                lon: 77.59,
                video: "Ellora caves.mp4",
                desc: "A stunning temple site, rich with history and architectural beauty."
            },
            "heritage2": {
                lat: 12.99,
                lon: 77.61,
                video: "Ellora caves.mp4",
                desc: "An ornate, historic palace showcasing royal heritage."
            },
            "heritage3": {
                lat: 12.98,
                lon: 77.605,
                video: "https://assets.mixkit.co/videos/preview/mixkit-drone-view-of-an-ancient-temple-34208-large.mp4",
                desc: "Explore the ancient ruins of a forgotten era."
            },
            "heritage4": {
                lat: 12.965,
                lon: 77.595,
                images: ["https://source.unsplash.com/400x300/?historic,india"],
                desc: "A beautiful historic building with intricate details."
            },
            "heritage5": {
                lat: 12.975,
                lon: 77.585,
                images: ["https://source.unsplash.com/400x300/?historic,india"],
                desc: "An aerial view of the city's urban heritage."
            },
        };
        // small UI helpers
        const toast = document.getElementById('toast');

        function showToast(msg, ms = 2200) {
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), ms);
        }
        // defer map init until DOM ready
        let map, currentMarker = null;

        function initMap() {
            if (map) return;
            map = L.map('map', {
                zoomControl: true
            }).setView([12.9716, 77.5946], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }
        // UI elements
        const navToggle = document.getElementById('nav-toggle');
        const mainNav = document.getElementById('main-nav');
        const mapSection = document.getElementById('map-section');
        const mapCloseBtn = document.getElementById('map-close');
        const mapToggleBtn = document.getElementById('map-toggle-btn');
        const openMapCta = document.getElementById('open-map-cta');
        const infoTitle = document.getElementById('info-title');
        const infoDesc = document.getElementById('info-desc');
        const relatedMedia = document.getElementById('related-media');
        const mapSearchInput = document.getElementById('map-search');
        const mapSearchBtn = document.getElementById('map-search-btn');
        // NAV toggle (three dots): slide-down mobile nav
        navToggle.addEventListener('click', () => {
            const open = mainNav.classList.toggle('open');
            navToggle.setAttribute('aria-expanded', open ? 'true' : 'false');
        });

        // show/hide map overlay
        function showMapView(locationName) {
            initMap();
            mapSection.style.display = 'flex';
            mapSection.setAttribute('aria-hidden', 'false');
            // ensure Leaflet sizes correctly after display
            setTimeout(() => {
                try {
                    map.invalidateSize();
                } catch (e) {}
            }, 200);
            if (locationName && locations[locationName]) setMapLocation(locations[locationName], locationName);
            else {
                map.setView([12.9716, 77.5946], 13);
                infoTitle.textContent = 'Bengaluru';
                infoDesc.textContent = 'Use the search box or tap a card to view details.';
                relatedMedia.innerHTML = '<div style="color:var(--muted);padding:8px">No media available</div>';
            }
        }
        function hideMapView() {
            mapSection.style.display = 'none';
            mapSection.setAttribute('aria-hidden', 'true');
            if (currentMarker) {
                try {
                    map.removeLayer(currentMarker);
                } catch (e) {}
                currentMarker = null;
            }
            // stop any playing video in related media
            const playingVideo = relatedMedia.querySelector('video');
            if (playingVideo) {
                try { playingVideo.pause(); }
                catch (e) {}
            }
        }
        function setMapLocation(loc, name) {
            if (!map) initMap();
            map.setView([loc.lat, loc.lon], 15);
            if (currentMarker) map.removeLayer(currentMarker);
            currentMarker = L.marker([loc.lat, loc.lon]).addTo(map).bindPopup(name).openPopup();
            infoTitle.textContent = name;
            infoDesc.textContent = loc.desc || 'No description available.';
            relatedMedia.innerHTML = '';
            if (loc.video) {
                // create a larger video for the info panel (autoplays muted to ensure autoplay works reliably)
                const video = document.createElement('video');
                video.src = loc.video;
                video.controls = true;
                video.autoplay = true;
                video.loop = true;
                // muted so autoplay works reliably across browsers after user click on card
                video.muted = true;
                video.playsInline = true;
                video.setAttribute('playsinline', '');
                video.setAttribute('draggable', 'false');
                relatedMedia.appendChild(video);
                // optionally try to unmute after a short user-initiated interaction (left commented)
                // setTimeout(() => { video.muted = false; }, 1000);
            } else if (Array.isArray(loc.images) && loc.images.length) {
                loc.images.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.alt = name;
                    relatedMedia.appendChild(img);
                });
            } else {
                relatedMedia.innerHTML = '<div style="color:var(--muted);padding:8px">No related media.</div>';
            }
        }
        // bind clicks for slider cards
        function bindSliderClicks() {
            document.querySelectorAll('.location-card, .heritage-card, .hidden-gem-card').forEach(card => {
                // remove duplicate listeners defensively
                card.replaceWith(card.cloneNode(true));
            });
            // re-select because we replaced nodes above
            document.querySelectorAll('.location-card, .heritage-card, .hidden-gem-card').forEach(card => {
                card.addEventListener('click', () => {
                    const locKey = card.dataset.location;
                    if (!locKey) return;
                    if (!locations[locKey]) {
                        showMapView(null);
                        showToast('Location details not found: ' + locKey);
                        return;
                    }
                    showMapView(locKey);
                });
            });
        }
        // search via nominatim (first result)
        function performSearch() {
            const query = (mapSearchInput.value || '').trim();
            if (!query) return;
            const q = /beng(a|al)ore|bengaluru/i.test(query) ? query : query + ' Bengaluru';
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`).then(r => r.json()).then(data => {
                if (!data || data.length === 0) {
                    showToast('Location not found');
                    return;
                }
                const r = data[0];
                const lat = parseFloat(r.lat),
                    lon = parseFloat(r.lon);
                if (!map) initMap();
                map.setView([lat, lon], 15);
                if (currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([lat, lon]).addTo(map).bindPopup(`Search: ${query}`).openPopup();
                infoTitle.textContent = query;
                infoDesc.textContent = r.display_name || 'Search result';
                relatedMedia.innerHTML = '<div style="color:var(--muted);padding:8px">Search result — no media.</div>';
            }).catch(e => {
                console.error(e);
                showToast('Error fetching location');
            });
        }
        // minimal rocket visual effect (non-blocking)
        function animateFab(el) {
            if (!el) return;
            el.classList.add('fly');
            setTimeout(() => el.classList.remove('fly'), 700);
        }
        // ripple effect for cards
        function attachRipples() {
            document.querySelectorAll('.slider .card').forEach(card => {
                card.addEventListener('click', function(e) {
                    const ripple = document.createElement('span');
                    ripple.className = 'ripple';
                    const rect = card.getBoundingClientRect();
                    ripple.style.width = ripple.style.height = Math.max(rect.width, rect.height) + 'px';
                    ripple.style.left = (e.clientX - rect.left - rect.width / 2) + 'px';
                    ripple.style.top = (e.clientY - rect.top - rect.height / 2) + 'px';
                    card.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // ---------- Hidden Gems feature (keeps functionality, guarded if elements not present) ----------
        (function hiddenGems() {
            const LS_KEY = 'userHiddenGems_v1';
            const slider = document.getElementById('hidden-gems-slider');
            const gemForm = document.getElementById('gemForm');
            const gemMsg = document.getElementById('gem-msg');
            if (!slider || !gemForm) return; // defensive
            const slugify = s => s.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]/g, '');
            function renderGemCard(gem) {
                const card = document.createElement('div');
                card.className = 'card hidden-gem-card';
                card.dataset.location = gem.key;
                const mediaHtml = gem.images && gem.images.length > 0 ?
                    `<img src="${gem.images[0]}" alt="${gem.title}">` :
                    `<img src="https://source.unsplash.com/300x180/?travel,india" alt="${gem.title}">`;
                card.innerHTML = `${mediaHtml}<div class="label">${gem.title}</div>`;
                card.addEventListener('click', () => {
                    showMapView(gem.key);
                });
                slider.prepend(card);
            }
            function addGem(gem, save = true) {
                locations[gem.key] = {
                    lat: gem.lat,
                    lon: gem.lon,
                    images: gem.images,
                    desc: gem.desc
                };
                renderGemCard(gem);
                if (save) {
                    const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
                    arr.unshift(gem);
                    localStorage.setItem(LS_KEY, JSON.stringify(arr));
                }
            }
            function loadGems() {
                const arr = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
                arr.forEach(gem => addGem(gem, false));
            }
            async function geocode(loc) {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc + ' Bengaluru')}`);
                    const data = await res.json();
                    if (data.length) return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon)
                    }
                } catch (e) {
                    console.warn(e);
                }
                return {
                    lat: 12.9716,
                    lon: 77.5946
                };
            }
            gemForm.addEventListener('submit', async e => {
                e.preventDefault();
                const title = document.getElementById('gem-title').value.trim();
                const locText = document.getElementById('gem-location').value.trim();
                const desc = document.getElementById('gem-desc').value.trim();
                const img = document.getElementById('gem-image').value.trim();
                if (!title || !locText || !desc) {
                    gemMsg.textContent = 'Fill all fields';
                    return;
                }
                gemMsg.textContent = 'Locating...';
                const coords = await geocode(locText);
                const gem = {
                    key: 'gem-' + slugify(title) + '-' + Date.now(),
                    title,
                    lat: coords.lat,
                    lon: coords.lon,
                    images: img ? [img] : [],
                    desc
                };
                addGem(gem, true);
                gemForm.reset();
                gemMsg.textContent = 'Gem added!';
                setTimeout(() => gemMsg.textContent = '', 2000);
            });
            loadGems();
        })();

        // ---------- VIDEO INTERACTION FIX FOR HERITAGE SLIDER ----------
        // Goal:
        //  - Single click on the card (including when clicking video area) opens map and shows full video+desc
        //  - Double-click on the small slider video toggles play/pause locally (prevents map open on dblclick)
        function improveHeritageVideos() {
            document.querySelectorAll('#heritage-slider .card video').forEach(video => {
                try {
                    // ensure good mobile behavior
                    video.setAttribute('playsinline', '');
                    video.setAttribute('draggable', 'false');
                    video.style.touchAction = 'manipulation';
                    video.style.userSelect = 'none';
                    video.style.webkitUserDrag = 'none';
                } catch (e) {}
                // prevent dblclick from bubbling to the card click (so double-click won't open map)
                video.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    if (video.paused) video.play();
                    else video.pause();
                });
                // NOTE: we DO NOT stop propagation on single click -> card click still fires
            });
        }

        // ---------- INIT BINDINGS ----------
        document.addEventListener('DOMContentLoaded', () => {
            // apply improved video behaviour (playsinline etc + dblclick toggle)
            improveHeritageVideos();

            // init map lazily when user opens map
            bindSliderClicks();
            attachRipples();

            // map toggle handlers
            mapToggleBtn.addEventListener('click', () => {
                showMapView(null);
                animateFab(mapToggleBtn);
            });
            openMapCta.addEventListener('click', () => {
                showMapView(null);
                animateFab(openMapCta);
            });
            mapCloseBtn.addEventListener('click', hideMapView);
            // search handlers
            mapSearchBtn.addEventListener('click', performSearch);
            mapSearchInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') performSearch();
            });
            // chat and guide nav
            document.getElementById('chatbtn')?.addEventListener('click', () => {
                animateFab(document.getElementById('chatbtn'));
                window.location.href = 'chatbot.html';
            });
            document.getElementById('guidebtn')?.addEventListener('click', () => {
                window.location.href = 'guide.html';
            });
            // login handling (keeps existing localStorage username flow)
            (function setupLoginUI() {
              const loginContainer = document.getElementById('login-container');
              function renderLoggedOut() {
                loginContainer.innerHTML = `<button id="login-btn" class="btn ghost">Login</button>`;
                const btn = document.getElementById('login-btn');
                btn?.addEventListener('click', () => {
                  window.location.href = 'login.html';
                });
              }
              function renderLoggedIn(username, avatarUrl) {
                loginContainer.innerHTML = `
                  <div style="position:relative;display:flex;align-items:center;gap:8px;">
                    <button id="profile-btn" aria-haspopup="true" aria-expanded="false"
                            style="display:flex;align-items:center;gap:8px;border-radius:999px;border:0;background:transparent;cursor:pointer;padding:6px">
                      <img src="${avatarUrl || 'https://cdn-icons-png.flaticon.com/512/3135/3135715.png'}" alt="Profile" width="34" height="34" style="border-radius:50%;object-fit:cover;box-shadow:0 6px 18px rgba(0,0,0,0.12)">
                      <span style="font-weight:600">${username}</span>
                    </button>
                    <div id="profile-menu" role="menu" aria-hidden="true" style="position:absolute;right:0;top:56px;display:none;min-width:160px;background:white;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,0.12);overflow:hidden">
                      <button id="logout-btn" style="display:block;padding:10px 12px;width:100%;text-align:left;border:0;background:transparent;cursor:pointer">Logout</button>
                    </div>
                  </div>
                `;
                const profileBtn = document.getElementById('profile-btn');
                const menu = document.getElementById('profile-menu');
                const logoutBtn = document.getElementById('logout-btn');
                profileBtn?.addEventListener('click', (e) => {
                  const open = menu.style.display === 'block';
                  menu.style.display = open ? 'none' : 'block';
                  profileBtn.setAttribute('aria-expanded', open ? 'false' : 'true');
                  menu.setAttribute('aria-hidden', open ? 'true' : 'false');
                });
                document.addEventListener('click', (ev) => {
                  if (!profileBtn.contains(ev.target) && !menu.contains(ev.target)) {
                    menu.style.display = 'none';
                    profileBtn.setAttribute('aria-expanded', 'false');
                    menu.setAttribute('aria-hidden', 'true');
                  }
                });
                logoutBtn?.addEventListener('click', () => {
                  localStorage.removeItem('username');
                  localStorage.removeItem('avatar');
                  renderLoggedOut();
                  showToast('Logged out');
                });
              }
              const storedName = localStorage.getItem('username');
              const storedAvatar = localStorage.getItem('avatar');
              if (storedName) {
                renderLoggedIn(storedName, storedAvatar);
              } else {
                renderLoggedOut();
              }
            })();

            // small UX: keyboard ESC to close map or mobile nav
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (mapSection.style.display === 'flex') hideMapView();
                    if (mainNav.classList.contains('open')) {
                        mainNav.classList.remove('open');
                        navToggle.setAttribute('aria-expanded', 'false');
                    }
                }
            });
            // ensure newly added gem cards work
            const observer = new MutationObserver(() => {
                bindSliderClicks();
                attachRipples();
                // reapply video improvements to any newly added heritage videos (if any)
                improveHeritageVideos();
            });
            observer.observe(document.getElementById('hidden-gems-slider'), {
                childList: true,
                subtree: true
            });
        });
    </script>
</body>
</html>
